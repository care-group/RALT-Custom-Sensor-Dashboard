<html>

<head>
    <title>RALT Signalman Dashboard</title>

    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link href="https://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css" rel="stylesheet">

    <link rel="stylesheet" href="css/main.css">
</head>

<body onload="update()">

    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#"><img src="assets/ralt_house.png" height=55px></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="index.html">Control</a>
                            <span class="sr-only">(current)</span>
                        </a>
                    </li>
                    <li class="nav-item inactive">
                        <a class="nav-link" href='status.html'>Sensor Status</a>
                    </li>
                    <li class="nav-item inactive">
                        <a class="nav-link" href='test.html'>Sensor Test</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <header class="py-2 mb-5" style="background-image: url('assets/header-pink.png'); background-size: auto 100%; height: 250px;">
    </header>

    <div class="container">
        <div class="row">
            <div class="col-sm">
                <h2>Status</h2>
                <hr>

                <h3>Target Topics</h3>
                <pre><samp id="topics"></samp></pre>
                <div class="alert alert-warning" role="alert">
                    These are the topics that RALT Signalman will attempt to record. It is not a guarantee that they are online. Validate that your topics are available using <code>rostopic list</code> on the host.
                </div>

                <h3>Recording Status</h3>
                <code id="status">
                    Not recording.
                </code>
                <br>
                <br>

                <h3>Container Status</h3>
                <code id="container_status">

                </code>
                <br>

                <h3>Bag Files</h3>
                <code id="bagfile">
                    None.
                </code>
                <br>
                <code id="bagfile_hsr">
                    None.
                </code>
                <br>
                <code id="bagfile_merged">
                    None.
                </code>
                <br>
                <br>

                <h3>Video Files</h3>
                <code id="video_1">
                    None.
                </code>
                <br>
                <code id="video_2">
                    None.
                </code>
                <br>
                <code id="video_3">
                    None.
                </code>
            </div>
            <div class="col-sm">
                <h2>Control</h2>
                <hr>

                <h3>Manual Recording</h3>
                <button type="button" style="width:49%;" class="btn btn-success" onclick="send_start_cmd('none')">Start</button>
                <button type="button" style="width:49%;" class="btn btn-danger" onclick="send_stop_cmd()">Stop</button>
                <br>
                <br>

                <h3>Activity Recording</h3>
                <button type="button" style="width:32%; margin-top:0pt;" class="btn btn-success" onclick="send_start_cmd('prepare_cold_meal')">Prepare Cold Meal</button>
                <button type="button" style="width:33%; margin-top:0pt;" class="btn btn-success" onclick="send_start_cmd('prepare_hot_meal')">Prepare Hot Meal</button>
                <button type="button" style="width:32%; margin-top:0pt;" class="btn btn-success" onclick="send_start_cmd('prepare_cold_drink')">Prepare Cold Drink</button>

                <button type="button" style="width:32%; margin-top:5pt;" class="btn btn-success" onclick="send_start_cmd('prepare_hot_drink')">Prepare Hot Drink</button>
                <button type="button" style="width:33%; margin-top:5pt;" class="btn btn-success" onclick="send_start_cmd('setting_table')">Setting Table</button>
                <button type="button" style="width:32%; margin-top:5pt;" class="btn btn-success" onclick="send_start_cmd('eating_table')">Eating (Table)</button>

                <button type="button" style="width:32%; margin-top:5pt;" class="btn btn-success" onclick="send_start_cmd('washing_dishes')">Washing Dishes</button>
                <button type="button" style="width:33%; margin-top:5pt;" class="btn btn-success" onclick="send_start_cmd('cleaning_kitchen')">Cleaning (Kitchen)</button>
                <button type="button" style="width:32%; margin-top:5pt;" class="btn btn-success" onclick="send_start_cmd('working_table')">Working (Table)</button>

                <button type="button" style="width:32%; margin-top:5pt;" class="btn btn-success" onclick="send_start_cmd('watching_tv')">Watching TV</button>
                <button type="button" style="width:33%; margin-top:5pt;" class="btn btn-success" onclick="send_start_cmd('reading_sofa')">Reading (Sofa)</button>
                <button type="button" style="width:32%; margin-top:5pt;" class="btn btn-success" onclick="send_start_cmd('toileting')">Toileting</button>

                <button type="button" style="width:32%; margin-top:5pt;" class="btn btn-success" onclick="send_start_cmd('showering')">Showering</button>
                <button type="button" style="width:33%; margin-top:5pt;" class="btn btn-success" onclick="send_start_cmd('dressing')">Dressing</button>
                <button type="button" style="width:32%; margin-top:5pt;" class="btn btn-success" onclick="send_start_cmd('reading_bed')">Reading (Bed)</button>

                <button type="button" style="width:32%; margin-top:5pt;" class="btn btn-success" onclick="send_start_cmd('sleeping')">Sleeping</button>
                <button type="button" style="width:100%; margin-top:5pt;" class="btn btn-danger" onclick="send_stop_cmd()">Stop</button>
                <br>
                <br>

                <h3>Merge Bag Files</h3>
                <button type="button" style="width:100%;" class="btn btn-info" onclick="merge_bag_files()">Merge</button>
                <br>
                <br>
            </div>
        </div>
    </div>

    <script>
        function update(){
            $.ajax({
                url: 'http://127.0.1.1:5002/status',
                method: "GET",
                headers: {
                    "Content-Type": "application/txt",
                },
                data: "",
                success: function (data) {
                    console.log('Successful response from main backend!')
                    console.log(data)
                    render_status(data)
                    render_status_container("online", "ralt_signalman")
                },
                error: function (data) {
                    $("#sensors").append("The sensor status API is unavailable. Please check the container logs for errors.")
                    console.log('Failed response from main backend!')
                    console.log(data)
                    render_status_container("offline", "ralt_signalman")
                }
            })
            $.ajax({
                url: 'http://127.0.1.1:5004/status',
                method: "GET",
                headers: {
                    "Content-Type": "application/txt",
                },
                data: "",
                success: function (data) {
                    console.log('Successful response from HSR backend!')
                    console.log(data)
                    render_status_hsr(data)
                    render_status_container("online", "ralt_signalman_hsr")
                },
                error: function (data) {
                    console.log('Failed response from HSR backend!')
                    console.log(data)
                    render_status_container("offline", "ralt_signalman_hsr")
                }
            })
            $.ajax({
                url: 'http://127.0.1.1:5006/status',
                method: "GET",
                headers: {
                    "Content-Type": "application/txt",
                },
                data: "",
                success: function (data) {
                    console.log('Successful response from webcams backend!')
                    console.log(data)
                    render_status_video(data)
                    render_status_container("online", "ralt_signalman_webcam")
                },
                error: function (data) {
                    console.log('Failed response from webcams backend!')
                    console.log(data)
                    render_status_container("offline", "ralt_signalman_webcam")
                }
            })
            $.ajax({
                url: 'http://127.0.1.1:5009/status',
                method: "GET",
                headers: {
                    "Content-Type": "application/txt",
                },
                data: "",
                success: function (data) {
                    console.log('Successful response from ralt_semantic_event_logger backend!')
                    console.log(data)
                    render_status_container("online", "ralt_semantic_event_logger")
                },
                error: function (data) {
                    console.log('Failed response from ralt_semantic_event_logger backend!')
                    console.log(data)
                    render_status_container("offline", "ralt_semantic_event_logger")
                }
            })
            $.ajax({
                url: 'http://127.0.1.1:5008/status',
                method: "GET",
                headers: {
                    "Content-Type": "application/txt",
                },
                data: "",
                success: function (data) {
                    console.log('Successful response from apple_watch_publisher backend!')
                    console.log(data)
                    render_status_container("online", "apple_watch_publisher")
                },
                error: function (data) {
                    console.log('Failed response from apple_watch_publisher backend!')
                    console.log(data)
                    render_status_container("offline", "apple_watch_publisher")
                }
            })
        }

        function render_status(data){
            bagfile = data["bagfile"]
            running = data["running"]
            topics = data["topics"]
            merged_bagfile = data["merged_bagfile"]

            jQuery.each(topics, function(i, val) {
                $( "#topics" ).append(val+"<br>")
            });

            $( "#status" ).empty()
            if (running){
                $( "#status" ).append("<span class='green_box'>RUNNING</span>")
            }
            else{
                $( "#status" ).append("<span class='red_box'>STOPPED</span>")
            }

            $( "#bagfile" ).empty()
            $( "#bagfile" ).append(bagfile)
            
            $( "#bagfile_merged" ).empty()
            $( "#bagfile_merged" ).append(merged_bagfile)
        }

        function render_status_hsr(data){
            bagfile = data["bagfile"]
            running = data["running"]
            topics = data["topics"]

            $( "#bagfile_hsr" ).empty()
            $( "#bagfile_hsr" ).append(bagfile)
        }

        function render_status_video(data){
            video_1 = data["camera_1"]
            video_2 = data["camera_2"]
            video_3 = data["camera_3"]

            $( "#video_1" ).empty()
            $( "#video_1" ).append(video_1)

            $( "#video_2" ).empty()
            $( "#video_2" ).append(video_2)
            
            $( "#video_3" ).empty()
            $( "#video_3" ).append(video_3)
        }

        function render_status_container(status, container){
            if(container == "ralt_signalman"){
                if(status == "online"){
                    $( "#container_status" ).append("<span class='green_box'>ralt_signalman</span><br>")
                } else {
                    $( "#container_status" ).append("<span class='red_box'>ralt_signalman</span><br>")
                }
            }
            if(container == "ralt_signalman_webcam"){
                if(status == "online"){
                    $( "#container_status" ).append("<span class='green_box'>ralt_signalman_webcam</span><br>")
                } else {
                    $( "#container_status" ).append("<span class='red_box'>ralt_signalman_webcam</span><br>")
                }
            }
            if(container == "apple_watch_publisher"){
                if(status == "online"){
                    $( "#container_status" ).append("<span class='green_box'>apple_watch_publisher</span><br>")
                } else {
                    $( "#container_status" ).append("<span class='red_box'>apple_watch_publisher</span><br>")
                }
            }
            if(container == "ralt_signalman_hsr"){
                if(status == "online"){
                    $( "#container_status" ).append("<span class='green_box'>ralt_signalman_hsr</span><br>")
                } else {
                    $( "#container_status" ).append("<span class='red_box'>ralt_signalman_hsr</span><br>")
                }
            }
            if(container == "ralt_semantic_event_logger"){
                if(status == "online"){
                    $( "#container_status" ).append("<span class='green_box'>ralt_semantic_event_logger</span><br>")
                } else {
                    $( "#container_status" ).append("<span class='red_box'>ralt_semantic_event_logger</span><br>")
                }
            }
        }

        function send_start_cmd(activity){
            $.ajax({
                url: 'http://127.0.1.1:5002/control',
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                data: JSON.stringify({ command: 'True', activity: activity}),
                success: function (data) {
                    console.log('Successful response from main backend!')
                    console.log(data)
                },
                error: function (data) {
                    $("#sensors").append("The Signalman backend is unavailable. Please check the container logs for errors.")
                    console.log('Failed response from main backend!')
                    console.log(data)
                }
            })
            $.ajax({
                url: 'http://127.0.1.1:5004/control',
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                data: JSON.stringify({ command: 'True', activity: activity}),
                success: function (data) {
                    console.log('Successful response from HSR backend!')
                    console.log(data)
                },
                error: function (data) {
                    $("#sensors").append("The Signalman backend (HSR) is unavailable. Please check the container logs for errors.")
                    console.log('Failed response from HSR backend!')
                    console.log(data)
                }
            })
            $.ajax({
                url: 'http://127.0.1.1:5006/control',
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                data: JSON.stringify({ command: 'True', activity: activity}),
                success: function (data) {
                    console.log('Successful response from webcams backend!')
                    console.log(data)
                },
                error: function (data) {
                    $("#sensors").append("The Signalman backend (webcams) is unavailable. Please check the container logs for errors.")
                    console.log('Failed response from webcams backend!')
                    console.log(data)
                }
            })
            $.ajax({
                url: 'http://127.0.1.1:5009/control',
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                data: JSON.stringify({ command: 'True', activity: activity}),
                success: function (data) {
                    console.log('Successful response from ralt_semantic_event_logger container!')
                    console.log(data)
                },
                error: function (data) {
                    console.log('Failed response from ralt_semantic_event_logger container!')
                    console.log(data)
                }
            })
            $.ajax({
                url: 'http://127.0.1.1:5008/control',
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                data: JSON.stringify({ command: 'True', activity: activity}),
                success: function (data) {
                    console.log('Successful response from apple_watch_publisher container!')
                    console.log(data)
                },
                error: function (data) {
                    console.log('Failed response from apple_watch_publisher container!')
                    console.log(data)
                }
            })
            setTimeout(function(){
                location.reload();
            }, 2000);
        }

        function send_stop_cmd(){
            let activity = 'none';
            $.ajax({
                url: 'http://127.0.1.1:5002/control',
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                data: JSON.stringify({ command: 'False', activity: activity}),
                success: function (data) {
                    console.log('Successful response from main backend!')
                    console.log(data)
                },
                error: function (data) {
                    $("#sensors").append("The Signalman backend is unavailable. Please check the container logs for errors.")
                    console.log('Failed response from main backend!')
                    console.log(data)
                }
            })
            $.ajax({
                url: 'http://127.0.1.1:5004/control',
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                data: JSON.stringify({ command: 'False', activity: activity}),
                success: function (data) {
                    console.log('Successful response from HSR backend!')
                    console.log(data)
                },
                error: function (data) {
                    $("#sensors").append("The Signalman backend (HSR) is unavailable. Please check the container logs for errors.")
                    console.log('Failed response from HSR backend!')
                    console.log(data)
                }
            })
            $.ajax({
                url: 'http://127.0.1.1:5006/control',
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                data: JSON.stringify({ command: 'False', activity: activity}),
                success: function (data) {
                    console.log('Successful response from webcams backend!')
                    console.log(data)
                },
                error: function (data) {
                    $("#sensors").append("The Signalman backend (webcams) is unavailable. Please check the container logs for errors.")
                    console.log('Failed response from webcams backend!')
                    console.log(data)
                }
            })
            $.ajax({
                url: 'http://127.0.1.1:5009/control',
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                data: JSON.stringify({ command: 'False', activity: activity}),
                success: function (data) {
                    console.log('Successful response from ralt_semantic_event_logger container!')
                    console.log(data)
                },
                error: function (data) {
                    console.log('Failed response from ralt_semantic_event_logger container!')
                    console.log(data)
                }
            })
            $.ajax({
                url: 'http://127.0.1.1:5008/control',
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                data: JSON.stringify({ command: 'False', activity: activity}),
                success: function (data) {
                    console.log('Successful response from apple_watch_publisher container!')
                    console.log(data)
                },
                error: function (data) {
                    console.log('Failed response from apple_watch_publisher container!')
                    console.log(data)
                }
            })
            setTimeout(function(){
                location.reload();
            }, 2000);
        }

        function merge_bag_files(){
            $.ajax({
                url: 'http://127.0.1.1:5002/merge',
                method: "POST",
                headers: {
                    "Content-Type": "application/txt",
                },
                data: $( "#bagfile_hsr" ).text(),
                success: function (data) {
                    console.log('Successful merge request!')
                    console.log(data)
                    setTimeout(function(){
                        location.reload();
                    }, 2000);
                },
                error: function (data) {
                    $("#sensors").append("Either the Signalman backend is unavailable, or the process to merge bag files has failed. Please check the container logs for errors.")
                    console.log('Failed response from main backend!')
                    console.log(data)
                }
            })
        }

        const interval = setInterval(function() {
            location.reload();
        }, 30000);
    </script>

</body>

</html>
