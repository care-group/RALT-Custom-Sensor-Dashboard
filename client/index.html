<html>

<head>
    <title>RALT Signalman Dashboard</title>

    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link href="https://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css" rel="stylesheet">

    <link rel="stylesheet" href="css/main.css">
</head>

<body onload="update()">

    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#"><img src="assets/ralt_house.png" height=55px></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="index.html">Control</a>
                            <span class="sr-only">(current)</span>
                        </a>
                    </li>
                    <li class="nav-item inactive">
                        <a class="nav-link" href='status.html'>Sensor Status</a>
                    </li>
                    <li class="nav-item inactive">
                        <a class="nav-link" href='test.html'>Sensor Test</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <header class="py-2 mb-5" style="background-image: url('assets/header-pink.png'); background-size: auto 100%; height: 250px;">
    </header>

    <div class="container">
        <div class="row">
            <div class="col-sm">
                <h2>Status</h2>
                <hr>

                <h3>Target Topics</h3>
                <pre><samp id="topics"></samp></pre>
                <div class="alert alert-warning" role="alert">
                    These are the topics that RALT Signalman will attempt to record. It is not a guarantee that they are online. Validate that your topics are available using <code>rostopic list</code> on the host.
                </div>

                <h3>Status</h3>
                <code id="status">
                    Not recording.
                </code>
                <br>
                <br>

                <h3>Bag Files</h3>
                <code id="bagfile">
                    [MAIN] None.
                </code>
                <br>
                <code id="bagfile_hsr">
                    [HSR] None.
                </code>
                <br>
                <code id="bagfile_merged">
                    [MERGED] None.
                </code>
            </div>
            <div class="col-sm">
                <h2>Control</h2>
                <hr>

                <h3>Bag File Recording</h3>
                <button type="button" class="btn btn-success" onclick="send_start_cmd()">Start</button>
                <button type="button" class="btn btn-danger" onclick="send_stop_cmd()">Stop</button>
                <br>
                <br>

                <h3>Merge Bag Files</h3>
                <button type="button" class="btn btn-info" onclick="merge_bag_files()">Merge</button>
                <br>
                <br>
            </div>
        </div>
    </div>

    <script>
        function update(){
            $.ajax({
                url: 'http://127.0.1.1:5002/status',
                method: "GET",
                headers: {
                    "Content-Type": "application/txt",
                },
                data: "",
                success: function (data) {
                    console.log('Success!')
                    console.log(data)
                    render_status(data)
                },
                error: function (data) {
                    $("#sensors").append("The sensor status API is unavailable. Please check the container logs for errors.")
                    console.log('Failed!')
                    console.log(data)
                }
            })
            $.ajax({
                url: 'http://127.0.1.1:5004/status',
                method: "GET",
                headers: {
                    "Content-Type": "application/txt",
                },
                data: "",
                success: function (data) {
                    console.log('Success!')
                    console.log(data)
                    render_status_hsr(data)
                },
                error: function (data) {
                    console.log('Failed!')
                    console.log(data)
                }
            })
        }

        function render_status(data){
            bagfile = data["bagfile"]
            running = data["running"]
            topics = data["topics"]
            merged_bagfile = data["merged_bagfile"]

            jQuery.each(topics, function(i, val) {
                $( "#topics" ).append(val+"<br>")
            });

            $( "#status" ).empty()
            if (running){
                $( "#status" ).append("<span class='green_box'>RUNNING</span>")
            }
            else{
                $( "#status" ).append("<span class='red_box'>STOPPED</span>")
            }

            $( "#bagfile" ).empty()
            $( "#bagfile" ).append("[MAIN] ")
            $( "#bagfile" ).append(bagfile)
            
            $( "#bagfile_merged" ).empty()
            $( "#bagfile_merged" ).append("[MERGED] ")
            $( "#bagfile_merged" ).append(merged_bagfile)
        }

        function render_status_hsr(data){
            bagfile = data["bagfile"]
            running = data["running"]
            topics = data["topics"]

            $( "#bagfile_hsr" ).empty()
            $( "#bagfile_hsr" ).append("[HSR]  ")
            $( "#bagfile_hsr" ).append(bagfile)
        }

        function send_start_cmd(){
            $.ajax({
                url: 'http://127.0.1.1:5002/control',
                method: "POST",
                headers: {
                    "Content-Type": "application/txt",
                },
                data: "True",
                success: function (data) {
                    console.log('Success!')
                    console.log(data)
                    setTimeout(function(){
                        location.reload();
                    }, 2000);
                },
                error: function (data) {
                    $("#sensors").append("The Signalman backend is unavailable. Please check the container logs for errors.")
                    console.log('Failed!')
                    console.log(data)
                }
            })
            $.ajax({
                url: 'http://127.0.1.1:5004/control',
                method: "POST",
                headers: {
                    "Content-Type": "application/txt",
                },
                data: "True",
                success: function (data) {
                    console.log('Success!')
                    console.log(data)
                    setTimeout(function(){
                        location.reload();
                    }, 2000);
                },
                error: function (data) {
                    $("#sensors").append("The Signalman backend (HSR) is unavailable. Please check the container logs for errors.")
                    console.log('Failed!')
                    console.log(data)
                }
            })
        }

        function send_stop_cmd(){
            $.ajax({
                url: 'http://127.0.1.1:5002/control',
                method: "POST",
                headers: {
                    "Content-Type": "application/txt",
                },
                data: "False",
                success: function (data) {
                    console.log('Success!')
                    console.log(data)
                    setTimeout(function(){
                        location.reload();
                    }, 2000);
                },
                error: function (data) {
                    $("#sensors").append("The Signalman backend is unavailable. Please check the container logs for errors.")
                    console.log('Failed!')
                    console.log(data)
                }
            })
            $.ajax({
                url: 'http://127.0.1.1:5004/control',
                method: "POST",
                headers: {
                    "Content-Type": "application/txt",
                },
                data: "False",
                success: function (data) {
                    console.log('Success!')
                    console.log(data)
                    setTimeout(function(){
                        location.reload();
                    }, 2000);
                },
                error: function (data) {
                    $("#sensors").append("The Signalman backend (HSR) is unavailable. Please check the container logs for errors.")
                    console.log('Failed!')
                    console.log(data)
                }
            })
        }

        function merge_bag_files(){
            $.ajax({
                url: 'http://127.0.1.1:5002/merge',
                method: "POST",
                headers: {
                    "Content-Type": "application/txt",
                },
                data: $( "#bagfile_hsr" ).text(),
                success: function (data) {
                    console.log('Success!')
                    console.log(data)
                    setTimeout(function(){
                        location.reload();
                    }, 2000);
                },
                error: function (data) {
                    $("#sensors").append("Either the Signalman backend is unavailable, or the process to merge bag files has failed. Please check the container logs for errors.")
                    console.log('Failed!')
                    console.log(data)
                }
            })
        }

        const interval = setInterval(function() {
            location.reload();
        }, 10000);
    </script>

</body>

</html>
